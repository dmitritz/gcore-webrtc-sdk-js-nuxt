<script setup lang="ts">
import { WebrtcStreamingEvents } from "@gcorevideo/rtckit";

import useMediaDevices from '~/composables/use-media-devices'
import useUserMedia from '~/composables/use-user-media'
import useWebrtcStreaming from '~/composables/use-webrtc-streaming';

const mediaDevices = useMediaDevices()

const userMedia = useUserMedia()

const air = useAir()

const webrtcStreaming = useWebrtcStreaming().get();

webrtcStreaming.on(WebrtcStreamingEvents.MediaDeviceSwitch, (e) => {
  if (!mediaDevices.value.willUseMic || air.value.ended) {
    return
  }
  if (e.kind === "audio") {
    mediaDevices.value.micDeviceId = e.device.deviceId
  }
})

function onChange(id: string) {
  mediaDevices.value.micDeviceId = id
  mediaDevices.value.willUseMic = true
}

function onToggle() {
  if (air.value.live) {
    userMedia.value.micEnabled =
      !userMedia.value.micEnabled
  } else {
    mediaDevices.value.willUseMic =
      !mediaDevices.value.willUseMic
  }
}
</script>

<template>
  <device-settings
    :checked="mediaDevices.willUseMic"
    :device-id="
      mediaDevices.micDeviceId
    "
    :devices-list="
      mediaDevices.micDevicesList
    "
    :disabled="air.ended"
    label="Microphone"
    @change="onChange"
    @toggle="onToggle"
  />
</template>
